<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>HAMT: An Efficient Persistent Map</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript">
(function() {
  document.write('<link rel="stylesheet" href="katex/katex.min.css" />');
})();(function() {document.write('<scr' + 'ipt type="text/javascript" src="katex/katex.min.js"></scr' + 'ipt>');})();(function(f) {
  // A "simple" onLoad function
  if (window.document.readyState == "complete") {
    f();
  } else if (window.document.addEventListener) {
    window.document.addEventListener("DOMContentLoaded", f, false);
  } else if (window.attachEvent) {
    window.attachEvent("onreadystatechange", function() {
      if (window.document.readyState == "complete") {
        f();
      }
    });
  } else {
    var oldLoad = window.onload;
    if (typeof(oldLoad) == "function") {
      window.onload = function() {
        try {
          oldLoad();
        } finally {
          f();
        }
      };
    } else {
      window.onload = f;
    }
  }
})(function() {
  // This is an ugly way to change the doctype, in case the scribble document
  // did not use (with-html5).
  if (!(document.doctype && document.doctype.publicId == '')) {
    if (console && console.log) {
      console.log("Re-wrote the document to use the HTML5 doctype.\n"
                  + "  Consider using the following declaration:\n"
                  + "      @title[#:style (with-html5 manual-doc-style)]{…}");
    }
    var wholeDoc = '<!doctype HTML>\n' + document.documentElement.outerHTML;
    document.open();
    document.clear();
    document.write(wholeDoc);
  }
  var inlineElements = document.getElementsByClassName("texMathInline");
  for (var i = 0; i < inlineElements.length; i++) {
    var e = inlineElements[i];
    katex.render(e.textContent, e, { displayMode:false, throwOnError:false });
  }
  var displayElements = document.getElementsByClassName("texMathDisplay");
  for (var i = 0; i < displayElements.length; i++) {
    var e = displayElements[i];
    katex.render(e.textContent, e, { displayMode:true, throwOnError:false });
  }
});
</script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="" class="tocviewselflink" data-pltdoc="x">HAMT:<span class="mywbr"> &nbsp;</span> An Efficient Persistent Map</a></td></tr></table></div><div class="tocviewsublistonly" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="#%28part._.Introduction%29" class="tocviewlink" data-pltdoc="x">Introduction</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="#%28part._.Motivation__.Persistent__.Immutable_.Maps%29" class="tocviewlink" data-pltdoc="x">Motivation:<span class="mywbr"> &nbsp;</span> Persistent, Immutable Maps</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="#%28part._.Next__.Trees_and_.Tries%29" class="tocviewlink" data-pltdoc="x">Next:<span class="mywbr"> &nbsp;</span> Trees and Tries</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="#%28part._.Implementing_.H.A.M.T%29" class="tocviewlink" data-pltdoc="x">Implementing HAMT</a></td></tr></table></div></div></div><div class="tocsub"><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber"></span><a href="#%28part._.H.A.M.T__.An_.Efficient_.Persistent_.Map%29" class="tocsubseclink" data-pltdoc="x">HAMT:<span class="mywbr"> &nbsp;</span> An Efficient Persistent Map</a></td></tr><tr><td><span class="tocsublinknumber">1<tt>&nbsp;</tt></span><a href="#%28part._.Introduction%29" class="tocsubseclink" data-pltdoc="x">Introduction</a></td></tr><tr><td><span class="tocsublinknumber">2<tt>&nbsp;</tt></span><a href="#%28part._.Motivation__.Persistent__.Immutable_.Maps%29" class="tocsubseclink" data-pltdoc="x">Motivation:<span class="mywbr"> &nbsp;</span> Persistent, Immutable Maps</a></td></tr><tr><td><span class="tocsublinknumber">2.1<tt>&nbsp;</tt></span><a href="#%28part._.A_na_ve_persistant_map__association_lists%29" class="tocsubseclink" data-pltdoc="x">A naïve persistant map:<span class="mywbr"> &nbsp;</span> association lists</a></td></tr><tr><td><span class="tocsublinknumber">2.2<tt>&nbsp;</tt></span><a href="#%28part._linkedlist%29" class="tocsubseclink" data-pltdoc="x">Implementing association lists</a></td></tr><tr><td><span class="tocsublinknumber">3<tt>&nbsp;</tt></span><a href="#%28part._.Next__.Trees_and_.Tries%29" class="tocsubseclink" data-pltdoc="x">Next:<span class="mywbr"> &nbsp;</span> Trees and Tries</a></td></tr><tr><td><span class="tocsublinknumber">3.1<tt>&nbsp;</tt></span><a href="#%28part._.Worst_case_behavior%29" class="tocsubseclink" data-pltdoc="x">Worst case behavior</a></td></tr><tr><td><span class="tocsublinknumber">3.2<tt>&nbsp;</tt></span><a href="#%28part._.From_sorted_trees_to_tries__prefix_trees_%29" class="tocsubseclink" data-pltdoc="x">From sorted trees to tries (prefix trees)</a></td></tr><tr><td><span class="tocsublinknumber">3.2.1<tt>&nbsp;</tt></span><a href="#%28part._.Exploiting_the_.Trie%29" class="tocsubseclink" data-pltdoc="x">Exploiting the Trie</a></td></tr><tr><td><span class="tocsublinknumber">3.3<tt>&nbsp;</tt></span><a href="#%28part._.A_few_optimizations%29" class="tocsubseclink" data-pltdoc="x">A few optimizations</a></td></tr><tr><td><span class="tocsublinknumber">3.3.1<tt>&nbsp;</tt></span><a href="#%28part._.Reducing_the_.Height%29" class="tocsubseclink" data-pltdoc="x">Reducing the Height</a></td></tr><tr><td><span class="tocsublinknumber">3.3.2<tt>&nbsp;</tt></span><a href="#%28part._lazy%29" class="tocsubseclink" data-pltdoc="x">Build It Lazily</a></td></tr><tr><td><span class="tocsublinknumber">3.3.3<tt>&nbsp;</tt></span><a href="#%28part._compress%29" class="tocsubseclink" data-pltdoc="x">Reducing the Memory</a></td></tr><tr><td><span class="tocsublinknumber">4<tt>&nbsp;</tt></span><a href="#%28part._.Implementing_.H.A.M.T%29" class="tocsubseclink" data-pltdoc="x">Implementing HAMT</a></td></tr><tr><td><span class="tocsublinknumber">4.1<tt>&nbsp;</tt></span><a href="#%28part._.The_node_representation%29" class="tocsubseclink" data-pltdoc="x">The node representation</a></td></tr><tr><td><span class="tocsublinknumber">4.2<tt>&nbsp;</tt></span><a href="#%28part._.Finding_a_key-value_pair_in_.H.A.M.T%29" class="tocsubseclink" data-pltdoc="x">Finding a key-<wbr></wbr>value pair in HAMT</a></td></tr><tr><td><span class="tocsublinknumber">4.2.1<tt>&nbsp;</tt></span><a href="#%28part._.Lookup_from_an_inner_node%29" class="tocsubseclink" data-pltdoc="x">Lookup from an inner node</a></td></tr><tr><td><span class="tocsublinknumber">4.3<tt>&nbsp;</tt></span><a href="#%28part._.Inserting_.Into_.H.A.M.T%29" class="tocsubseclink" data-pltdoc="x">Inserting Into HAMT</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="versionNoNav">6.10.1</span></div><h2><a name="(part._.H.A.M.T__.An_.Efficient_.Persistent_.Map)"></a>HAMT: An Efficient Persistent Map</h2><p><a href="https://thomas.gilray.org/">Thomas Gilray</a> (<a href="https://twitter.com/tomgilray">@tomgilray</a> )
<br/>
<a href="http://kmicinski.com">Kristopher Micinski</a> (<a href="https://twitter.com/krismicinski">@krismicinski</a>)</p><h3>1<tt>&nbsp;</tt><a name="(part._.Introduction)"></a>Introduction</h3><h3>2<tt>&nbsp;</tt><a name="(part._.Motivation__.Persistent__.Immutable_.Maps)"></a>Motivation: Persistent, Immutable Maps</h3><p>Let&rsquo;s say we wanted to implement a phonebook using a mutable map:</p><blockquote class="SCentered"><p><img src="map1.png" alt="" width="276" height="176"/></p></blockquote><p>When a friend&rsquo;s number changes, we would make a corresponding change
to the map:</p><blockquote class="SCentered"><p><img src="map2.png" alt="" width="403" height="180"/></p></blockquote><p>Now imagine I want to keep a history of my phonebook. What I really
want is a time slider that allows me to see the state of the phonebook
at any point in time:</p><blockquote class="SCentered"><p><img src="maptime.png" alt="" width="574" height="173"/></p></blockquote><p>The problem with a mutable map is that I invalidate older copies of
the phonebook when I update keys that exist in the phonebook at
earlier times. Instead, I want an <span style="font-style: italic">immutable</span> data structure that
supports methods:</p><ul><li><p><span class="stt">map-&gt;insert(key,value)</span>, which gives me back a <span style="font-style: italic">new</span> map
containing all the same pairs as the old one, except for the newly
inserted pair (or with the value updated if <span class="stt">key</span> was already in the map).
That is, I want a functional insert operation that consumes and
produces immutable maps.</p></li><li><p><span class="stt">map-&gt;lookup(key)</span>, that efficiently looks up a record in the map.</p></li><li><p><span class="stt">map-&gt;remove(key)</span>, that deletes a record from the map. Just
like <span class="stt">insert</span>, this should both consume and produce a functional
map. The map returned should not contain <span class="stt">key</span> and the map consumed
should not be mutated and still contains <span class="stt">key</span> if it did already.</p></li></ul><p>Note that we could technically obtain a persistent map by simply
cloning a mutable map each time we perform a change:</p><blockquote class="SCentered"><p><img src="copymap.png" alt="" width="403" height="303"/></p></blockquote><p>But this uses linear time, linear space, and is slow in practice, which falls
far short of what we&rsquo;d like. As we&rsquo;ll see next, the key to a more efficient data
structure is immutability because this enables sharing (productive
persistance where portions of maps that are unchanged may be shared
across multiple versions).</p><h4>2.1<tt>&nbsp;</tt><a name="(part._.A_na_ve_persistant_map__association_lists)"></a>A na&#239;ve persistant map: association lists</h4><p>A simple example of an immutable, persistant data-structure is an association list.
Association lists are linked lists consisting of key-value pairs. To perform <span class="stt">map-&gt;lookup(k)</span>, we walk down the links
of <span class="stt">map</span> until we find a link with the corresponding key; if we reach the end of the list instead, the key was not found.</p><p>When association lists are updated, either new keys are appended to the front which shadow older keys, or the list is fully traversed
to maintain an invariant that at most one copy of a key has a binding at a time. For space efficiency, we present the later kind so that
sequences of inserts cannot build up arbitrarily large data structures that encode only a small number of visible keys.
Thus, to perform <span class="stt">map-&gt;insert(k,v)</span>, we traverse each link of
<span class="stt">map</span> (as in <span class="stt">lookup</span>) to ensure that no pair for <span class="stt">key</span>
already exists. If it does, we update the list from that point, emiting a new list that shares a tail
with the input list. If it does not, we append a link which contains <span class="stt">k,v</span> to
the end of the list, rebuilding the common prefix:</p><blockquote class="SCentered"><p><img src="assoclist2.png" alt="" width="344" height="85"/></p></blockquote><p>This means our lookup times can be in <span class="texMathInline">O(n)</span>, but then so are our
insert, remove and space overheads. In the case where keys that exist
in an input map are updated or removed, the returned list will share
its tail with the input association list. Both lists are immutable and
it&rsquo;s perfectly safe for us to exploit this fact by reusing portions of the input
map to encode portions of the output map where they don&rsquo;t need to change.
In the case of an association list, this doesn&rsquo;t affect the complexity class
of our operations (only improves constant factors) but it does illustrate the principle
of sharing and persistance that will make our HAMT data structure performant.</p><p><table cellspacing="0" cellpadding="0" class="boxed"><tr><td><p><span style="font-weight: bold">Operation</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p><span style="font-weight: bold">Runtime</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p><span style="font-weight: bold">Space overhead</span></p></td></tr><tr><td><p><span class="stt">insert</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p><span class="texMathInline">O(n)</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p><span class="texMathInline">O(n)</span></p></td></tr><tr><td><p><span class="stt">lookup</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p><span class="texMathInline">O(n)</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p>-</p></td></tr><tr><td><p><span class="stt">remove</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p><span class="texMathInline">O(n)</span></p></td><td><p><span class="hspace">&nbsp;</span></p></td><td><p><span class="texMathInline">O(n)</span></p></td></tr></table></p><p>In practice, association lists are not a particularly efficient data
structure on their own, but, in addition to illustrating the value of
immutability and persistance, they form a component of our final HAMT implementation.
To obtain HAMT, we&rsquo;ll use a tiered tree structure that, along with sharing at each
of its tiers, can terminate in association lists (that can also be shared between HAMT
instances).</p><h4>2.2<tt>&nbsp;</tt><a name="(part._linkedlist)"></a>Implementing association lists</h4><p>Let&rsquo;s see how we implement association lists. First,
we&rsquo;re going to represent each individual link as a key,
value, and pointer to the next node. We want the key and values
to be of arbitrary (but specified) types, so we&rsquo;re going to use C++
templates (generic programming). Let&rsquo;s start by stubbing out the class definition:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">template</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V&gt;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">class</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typedef</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">public:</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">next</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">next</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">next</span><span class="RktPn">(</span><span class="RktSym">next</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">find</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">insert</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">remove</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>Note on lines 7-9 that all of our pointer types have <span class="stt">const</span>
qualifiers, meaning we won&rsquo;t be able to modify the data
being pointed at, or the pointers to the keys and values
themselves. This is exactly the behavior we want for our
association list; otherwise, sharing portions of old association
lists would be impossible as modifying them could update all
maps that had previously been derived from them. Our constructor
therefore initializes fields and all other operations are <span class="stt">const</span>.</p><p>A find or lookup algorithm is defined as a straightforward traversal
that returns a <span class="stt">const V*</span> or null pointer.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">find</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">*</span><span class="RktPn">(</span><span class="RktSym">this-&gt;k</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">*k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">next</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">next-&gt;find</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>The insert algorithm descends the association list checking for a matching key (line 3). If it matches,
we rebuilt the current node using an updated value <span class="stt">LLtype(this-&gt;k, v, next)</span> (line 4) and <span style="font-style: italic">placement new</span>
syntax <span class="stt">new ((T*)ptr) T(...)</span> which constructs a value at an existing location, <span class="stt">ptr</span>&#8212;<wbr></wbr>in this case,
new memory obtained from the Boehm garbage collector.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">insert</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">*</span><span class="RktPn">(</span><span class="RktSym">this-&gt;k</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">*k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">LLtype*</span><span class="RktPn">)</span><span class="RktSym">GC_MALLOC</span><span class="RktPn">(</span><span class="RktSym">sizeof</span><span class="RktPn">(</span><span class="RktSym">LLtype</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype</span><span class="RktPn">(</span><span class="RktSym">this-&gt;k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">next</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">next</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">LLtype*</span><span class="RktPn">)</span><span class="RktSym">GC_MALLOC</span><span class="RktPn">(</span><span class="RktSym">sizeof</span><span class="RktPn">(</span><span class="RktSym">LLtype</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype</span><span class="RktPn">(</span><span class="RktSym">this-&gt;k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this-&gt;v</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">next-&gt;insert</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">link1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">LLtype*</span><span class="RktPn">)</span><span class="RktSym">GC_MALLOC</span><span class="RktPn">(</span><span class="RktSym">sizeof</span><span class="RktPn">(</span><span class="RktSym">LLtype</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype</span><span class="RktPn">(</span><span class="RktSym">this-&gt;k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this-&gt;v</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">link0</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">LLtype*</span><span class="RktPn">)</span><span class="RktSym">GC_MALLOC</span><span class="RktPn">(</span><span class="RktSym">sizeof</span><span class="RktPn">(</span><span class="RktSym">LLtype</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">link1</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">link0</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>In the case where the current link doesn&rsquo;t match but has a non-null tail, the current node is rebuilt to refer to whatever
<span class="stt">LLtype</span> pointer is returned from a recursive insert (line 6). If the end of the list is reached with no key found,
we may insert the new element on the front or back of the list. In this case we show the latter for simplicity.</p><h3>3<tt>&nbsp;</tt><a name="(part._.Next__.Trees_and_.Tries)"></a>Next: Trees and Tries</h3><p>A standard data structure in any programmer&rsquo;s arsenal is the sorted tree.
Trees give you nice logarithmic runtime costs when balanced.</p><blockquote class="SCentered"><p><img src="tree.png" alt="" width="386" height="174"/></p></blockquote><p>The problem with trees is that in the worse case they give
lookup performance no better than a list:</p><blockquote class="SCentered"><p><img src="badtree.png" alt="" width="392" height="195"/></p></blockquote><p>This happens when elements are inserted in order. A number
of techniques exist to avoid this worst-case behavior. For
example,
<a href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree">Red-Black trees</a> automatically rebalance upon each <span class="stt">insert</span>
 operation. Unfortunately, this requires mutability so
 an existing tree may be rewired into a more balanced version of itself.</p><p>A way of constructing a balanced binary tree probabilistically
would be to randomize elements before inserting them. This would
avoid the worst-case behavior of inserting elements in sorted order.
A way to effect this kind of probabalistic balancing, but without changing
insertion order, would be to hash each key and insert into
the tree based on its hash. So long as we only care to match keys
exactly and do not need to exploit an ordering on keys, this is a
sound alternative. Each node in the tree is now a:</p><ul><li><p>A pointer to the left and right subtrees</p></li><li><p>A hash of the key for that cell, and</p></li><li><p>A pointer to a linked list of key-value pairs</p></li></ul><p>The reason for the last item is that hashes have the
possibility of <span style="font-style: italic">collision</span>: two values can hash to the
same thing. If we use a sufficiently large hash, and a good
hash function, this will happen only rarely. Here&rsquo;s an example of
what our hash-tree looks like, with the linked lists
highlighted in green:</p><blockquote class="SCentered"><p><img src="hashtree.png" alt="" width="394" height="324"/></p></blockquote><h4>3.1<tt>&nbsp;</tt><a name="(part._.Worst_case_behavior)"></a>Worst case behavior</h4><p>Note that we have done nothing to improve the worst-case
behavior of our binary tree. We could still end up in this
scenario (note that the linked lists are elided):</p><blockquote class="SCentered"><p><img src="worsttree.png" alt="" width="381" height="213"/></p></blockquote><p>This means that the complexity of operations on our tree is
<span style="font-style: italic">still</span> <span class="texMathInline">O(n)</span>. Let&rsquo;s tackle that next.</p><h4>3.2<tt>&nbsp;</tt><a name="(part._.From_sorted_trees_to_tries__prefix_trees_)"></a>From sorted trees to tries (prefix trees)</h4><p>Turning our sorted tree into a hash-tree doesn&rsquo;t buy us any
performance improvement, but it helps us make our way
towards exploiting some of the unique properties of the
hash-tree.</p><p>Hashes naturally form a common-prefix ordering:</p><blockquote class="SCentered"><p><img src="prefixnums.png" alt="" width="94" height="135"/></p></blockquote><p>Each element in the sequence is a suffix of the element
before it. We can also represent the elements elements of a
binary tree:</p><blockquote class="SCentered"><p><img src="numbertrie.png" alt="" width="286" height="148"/></p></blockquote><p>However, note that if we force our tree to be a trie (pronounced "try"),
it is <span style="font-style: italic">not</span> possible to represent the worst-case
configuration shown above: <span class="stt">0x00000001</span> is not a prefix
of <span class="stt">0x00000002</span>.</p><h5>3.2.1<tt>&nbsp;</tt><a name="(part._.Exploiting_the_.Trie)"></a>Exploiting the Trie</h5><p>If we force our trees to be tries, and assuming we use a
64-bit hash, we can reduce the maximum depth of our trees
from <span class="texMathInline">O(n)</span> to just 64! The way we do this is to represent our
key-value pairs using a trie, where each node represents a
<span style="font-style: italic">partial</span> hash, a prefix. Note that&ndash;for now&ndash;we have left off
the value component of the key-value pairs and are simply
drawing the hashes. We will get back to that shortly.</p><blockquote class="SCentered"><p><img src="binarytrie.png" alt="" width="532" height="299"/></p></blockquote><p>Notice that each child node is arranged such that it is a
prefix of its parent. Our trie can be viewed as a decision
tree, at each step answering the question, "is the next bit zero or one?"
Keep in mind that, at leaf nodes, we will still have
to keep a key-value association list. It remains possible for us
to have (improbable) hash collisions.</p><h4>3.3<tt>&nbsp;</tt><a name="(part._.A_few_optimizations)"></a>A few optimizations</h4><p>Our trie now avoids the worst-case behavior we observed with
a sorted binary tree, which appears better in theory, but
has a few undesirable traits in practice:</p><ul><li><p>A maximum depth of 64 is still quite a large tree to traverse in the worst-case</p></li><li><p>In the case that the map is relatively sparse&ndash;i.e.,
that it doesn&rsquo;t contain many key-value pairs, we are still
required to traverse all the way down to the leaf just to lookup one key-value pair.</p></li></ul><h5>3.3.1<tt>&nbsp;</tt><a name="(part._.Reducing_the_.Height)"></a>Reducing the Height</h5><p>To solve the first problem, we can simply switch from a
binary tree to an n-ary tree: in our case, we&rsquo;re going to
hold 64 "buckets" at each node, rather than 2. By doing
this, we lower the maximum depth of our tree (to 10-11).
Instead of each node deciding whether a bit will be a 0 or a
1, each node will decide whether the next 6 bits of the hash
are <span class="stt">0x00</span> to <span class="stt">0x3F</span>:</p><blockquote class="SCentered"><p><img src="buckets.png" alt="" width="130" height="175"/></p></blockquote><p>Now our trie will have a structure like this:</p><blockquote class="SCentered"><p><img src="fullbuckets.png" alt="" width="246" height="207"/></p></blockquote><h5>3.3.2<tt>&nbsp;</tt><a name="(part._lazy)"></a>Build It Lazily</h5><p>It turns out that most of the time, our trie won&rsquo;t really
need to be of depth ten. In fact, in the following scenario,
we&rsquo;d waste a lot of time traversing pointers:</p><blockquote class="SCentered"><p><img src="wasted.png" alt="" width="334" height="317"/></p></blockquote><p>This is because each key occupies a different bucket for the
top level node. In fact, we could just use a
configuration like the following instead:</p><blockquote class="SCentered"><p><img src="lesswasted.png" alt="" width="225" height="301"/></p></blockquote><p>What we ultimately want is a data structure that stores the
key-value pair as close to the top as possible until it has
to keep things separate.</p><p>To do that, the nodes in our trie will either hold 64
buckets for child nodes, or will hold an association list of
key-value pairs. Remember, they can&rsquo;t possibly hold one unique key-value pair because hash collisions are always
possible. This optimizes our trie so that in cases that we
don&rsquo;t <span style="font-style: italic">need</span> additional depth, we won&rsquo;t be using it.
Additionally, assuming we&rsquo;re using a suitable hash function,
we should get relatively good dispersion between buckets.
This means that&ndash;probabilistically&ndash;we&rsquo;ll be holding most
things closer to the top until the map is holding a lot of
key-value pairs.</p><p>One way to think about this is that we will build the nodes
in our trie lazily, only using as many bits of the hash as
we need. If we can differentiate all of the hashes of our
key-value pairs using their first six bits, we will only
have one "layer" of the trie that we need to traverse untilxs
we reach the data we want to access.</p><p>If we lay out our trie in this manner, we need to be careful
about how insertion happens. For example, consider a trie
which stores a record for Jos&#233; near the top. Let&rsquo;s assume
the string "Jos&#233;" hashes to <span class="stt">0xFC0..</span> (we will only need
the first 12 digits for this example). Jos&#233;&rsquo;s record will be
stored in the key-value pair association list for the <span class="stt">0x3F</span> bucket of the first node. Now consider what happens
when we want to insert a key-value pair for Sam, which (for
the purposes of illustration) we will assume hashes to <span class="stt">0xFFF</span>. Because the first six binary digits of the hahes for
Jos&#233; and Sam both hash to <span class="stt">0x3F</span>, we will need to split
that bucket into <span style="font-style: italic">another</span> bucket, holding another 64
values.</p><p>Here&rsquo;s an illustration of how insert works given this
configuration:</p><blockquote class="SCentered"><p><img src="split.png" alt="" width="755" height="355"/></p></blockquote><h5>3.3.3<tt>&nbsp;</tt><a name="(part._compress)"></a>Reducing the Memory</h5><p>When the trie is relatively sparse, assigning 64 buckets to
each node is inefficient in terms of both space (occupied by
each node) and time (spent copying memory to allocate new
nodes). It turns out that we can use a low-level trick
to compress sparse nodes in the trie.</p><p>The trick is to use a bitmap to represent which
child hashes are actually stored in a node. Instead of each
node holding 64 buckets, a node will hold a single 64-bit
value, <span class="stt">bitmap</span>, along with a variable-length buffer of
pointers to child nodes, <span class="stt">data</span>. The node will be laid out
so that, if position i in <span class="stt">bitmap</span> is a 1
(i.e., <span class="stt">bitmap &amp; (0x01 &lt;&lt; i) &gt; 0</span>),
it will represent the fact that the
bucket i is occupied. We will lay out <span class="stt">data</span> such that
its length is equal to the number of 1s in the
binary representation of <span class="stt">bitmap</span>. The ith index into
<span class="stt">data</span> will be regarded as the bucket occupied by the
(i+1)th occurrence of 1 in the binary representation of <span class="stt">bitmap</span>.</p><p>This is tricky, so here&rsquo;s a picture:</p><blockquote class="SCentered"><p><img src="oldvsnew.png" alt="" width="562" height="243"/></p></blockquote><p>The old representation of a trie node is shown on the left.
The new, more efficient, representation is shown on the
right. In the old representation we can see 64 buckets, with
Jos&#233; occupying the first bucket at position <span class="stt">0x00</span>, and
Sam occupying the last at position <span class="stt">0x3F</span>. Between them
is 62 null pointers to pieces of hashes which have not yet
been inserted into the trie.</p><p>In our new representation we see the bitmap and a <span class="stt">data</span>
array of two elements. Because Jos&#233;&rsquo;s hash occupies position
<span class="stt">0x00</span> in the old representation, the 0th bit of <span class="stt">bitmap</span> will be set to 1. Similarly, because Sam&rsquo;s hash
occupied position <span class="stt">0x3F</span> in the old representation, the
63th bit of <span class="stt">bitmap</span> will be set.</p><p>To access Sam&rsquo;s record, we lookup position 63 in <span class="stt">bitmap</span>
and check to see whether it is set to 1. If not, it will
signify that no record exists for Sam in this node. Assuming
it is, we then count the number of 1s <span style="font-style: italic">below</span> position
63 in the bitmap. This operation is called <span class="stt">popcount</span>
(short for "population count," which counts the number of 1s
in a machine word), and built into many modern instruction
sets, so that it executes quite efficiently. We then use
<span class="stt">popcount</span> of the part of <span class="stt">bitmap</span> below the 63th bit
to index into <span class="stt">data</span>.</p><p>By doing this, we reduce the amount of space stored for each
node from 64 to <span class="stt">popcount(bitmap)</span>. In practice, this
means that we get good performance when the trie is sparse,
and when the trie is dense (i.e., most nodes hold close to
64 child elements) the performance is hardly worse than an
implementation without compression.</p><h3>4<tt>&nbsp;</tt><a name="(part._.Implementing_.H.A.M.T)"></a>Implementing HAMT</h3><p>The combination of these techniques gives us the Hash
Array-Mapped Trie (HAMT). Now we&rsquo;ll step through an
efficient implementation of HAMT that uses these concepts.</p><h4>4.1<tt>&nbsp;</tt><a name="(part._.The_node_representation)"></a>The node representation</h4><p>Nodes are represented by a templated C++ class <span class="stt">KV&lt;K,V,d&gt;</span>, where:</p><ul><li><p><span class="stt">K</span> is the template parameter for the key&rsquo;s type</p></li><li><p><span class="stt">V</span> is the value&rsquo;s type</p></li><li><p><span class="stt">d</span> is the depth of the node being represented</p></li></ul><p>The last parameter deserves some explanation. Imagine how
nodes are to be implemented. At each depth in the HAMT, a node
handles a 6-bit piece of a 64-bit hash. In our
implementation, the root node (which we&rsquo;ll implement soon as
a class called <span class="stt">hamt</span>) will hold 4 of those bits, while
the 60 remaining bits will be handled by sub-tries whose
maximum depth is 10. After depth 10, all values which would
share the same bucket also share the same hash, and so the trie
devolves into an association list.</p><p>To do its work, each inner node in HAMT must know which
6-bit piece of the hash its working on. We could handle this by
computing this value as we traverse down through the trie nodes,
gradually moving from the first four bits (for the
top level node, which holds four bits), to the next six
bits, to the next six bits, etc. However, instead, we&rsquo;re
going to use template metaprogramming to generate a
template-specialized version of the node class for each
depth from 1 to 10. This means that the C++ compiler will
generate <span class="stt">KV&lt;K,V,0&gt;</span> through <span class="stt">KV&lt;K,V,9&gt;</span> for us using
our template, and we will manually specialize <span class="stt">KV&lt;K,V,10&gt;</span>
to be an implementation that may use an association list.
In essence, we have traded various dynamic checks that would
otherwise happen at <span style="font-style: italic">runtime</span> for a specialization of the
code at <span style="font-style: italic">compile time</span>.</p><p>Here&rsquo;s the C++ code representation for our inner nodes:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">A</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key-value</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pair</span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">this</span><span class="hspace">&nbsp;</span><span class="RktCmt">is</span><span class="hspace">&nbsp;</span><span class="RktCmt">both</span><span class="hspace">&nbsp;</span><span class="RktCmt">one</span><span class="hspace">&nbsp;</span><span class="RktCmt">row</span><span class="hspace">&nbsp;</span><span class="RktCmt">in</span><span class="hspace">&nbsp;</span><span class="RktCmt">Bagwell's</span><span class="hspace">&nbsp;</span><span class="RktCmt">underlying</span><span class="hspace">&nbsp;</span><span class="RktCmt">AMT</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">or</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">buffer</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">such</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">rows</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">in</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">an</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">internal</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">structure</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">template</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">unsigned</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d&gt;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">class</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typedef</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV&lt;K</span><span class="RktSym">,</span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktSym">d&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typedef</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV&lt;K</span><span class="RktSym">,</span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktSym">d+1&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">public:</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">We</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">use</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">two</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">unions</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">following</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">cheap</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">tagging</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">scheme:</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">when</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">lowest</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bit</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktSym">,</span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pair</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">value</span><span class="RktPn">)</span><span class="RktSym">,</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">when</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">lowest</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bit</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">either</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">bitmap</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">in</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">top</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">63</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bits</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">with</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV&lt;K</span><span class="RktSym">,</span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktSym">d+1&gt;*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pointer</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">when</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">less</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">than</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">9</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">or</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">just</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pointer</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">collisions</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">union</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">(</span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">21</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktPn">(</span><span class="RktSym">bm</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">22</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">23</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">24</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">union</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Val</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">25</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">26</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">27</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">28</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">29</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Val</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktPn">(</span><span class="RktSym">node</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">30</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Val</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktPn">(</span><span class="RktSym">val</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">31</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">32</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">...</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">33</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>We use C++ unions to allow this node to either be a
key-value pair, or an inner node, to implement the trick in
section <a href="#%28part._lazy%29" data-pltdoc="x">Build It Lazily</a>. There are two possibilities for this node:</p><ul><li><p>It is a single key-value pair. In this case, we will
simply use the <span class="stt">K*</span>, <span class="stt">V*</span> pair. The bits of k will
encode a pointer to the key object, which we can use on subsequent
lookups. The reason we can do this is that pointers to keys
will always be aligned, and so the lowest bit will never be
zero! This allows us to use that lowest bit to tag these unions;
when it is a zero, <span class="stt">k</span> is a key and <span class="stt">v</span> is a stored value.</p></li><li><p>There is more than one matching key for this prefix.
In this case, we set the lowest bit of <span class="stt">k</span> to 1. The rest of <span class="stt">k</span> will
be a 63-bit bitmap, and <span class="stt">v</span> will point to a compressed buffer, <span class="stt">data</span>,
of keys and values as discussed in section <a href="#%28part._compress%29" data-pltdoc="x">Reducing the Memory</a>.</p></li></ul><p>The lowest level of our HAMT will either store keys and values or,
where collisions exist, the value 1 for <span class="stt">k</span> and a pointer to an association list
for <span class="stt">v</span>. This uses the linked list we implemented in section <a href="#%28part._linkedlist%29" data-pltdoc="x">Implementing association lists</a>:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">A</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">template-specialized</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">version</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV&lt;K</span><span class="RktSym">,</span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktSym">d&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">lowest</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">depth</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">nodes</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d==10</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">After</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">we</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">have</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">exhausted</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">our</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bit</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hash</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktVal">4</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bits</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">used</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">by</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">root</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">6*10</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bits</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">used</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">by</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">nodes</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">template</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V&gt;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">class</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV&lt;K</span><span class="RktSym">,</span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktSym">10&gt;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typedef</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typedef</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV&lt;K</span><span class="RktSym">,</span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktSym">10&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVbottom</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">public:</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">We</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">use</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">two</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">unions</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">following</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">cheap</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">tagging</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">scheme:</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">when</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">lowest</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bit</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktSym">,</span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pair</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">value</span><span class="RktPn">)</span><span class="RktSym">,</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">when</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">lowest</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bit</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">either</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">bitmap</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">in</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">top</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">63</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bits</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">with</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pointer</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">when</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">less</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">than</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">9</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">or</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">just</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pointer</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">collisions</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">In</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">case</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">we</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">use</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;*</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">union</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">(</span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">21</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Key</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktPn">(</span><span class="RktSym">bm</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">22</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">23</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">24</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">union</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Val</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">25</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">26</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">list</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">27</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">28</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">29</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Val</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LLtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">ll</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">list</span><span class="RktPn">(</span><span class="RktSym">ll</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">30</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Val</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktPn">(</span><span class="RktSym">val</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">31</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">32</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">...</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">33</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>The toplevel <span class="stt">hamt</span> data structure will hold the first
four bits of the hash, and each element of <span class="stt">data</span> will
hold either a key-value pair or an inner node:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">A</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">simple</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hash-array-mapped</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">trie</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">implementation</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">Bagwell</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">2001</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Garbage</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">collected</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">persistent/immutable</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hashmaps</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">template&lt;typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typename</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V&gt;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">class</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hamt</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">typedef</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV&lt;K</span><span class="RktSym">,</span><span class="RktSym">V</span><span class="RktSym">,</span><span class="RktSym">0&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtop</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">private:</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">We</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">use</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">up</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">4</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bits</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hash</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">root</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">then</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">other</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">10*6bits</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">are</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">used</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">nodes</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">up</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">10</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">deep</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtop</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktVal">16</span><span class="RktPn">]</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">public:</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hamt&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">:</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktPn">{</span><span class="RktPn">}</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktPn">(</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">...</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><h4>4.2<tt>&nbsp;</tt><a name="(part._.Finding_a_key-value_pair_in_.H.A.M.T)"></a>Finding a key-value pair in HAMT</h4><p>To find a key-value pair in HAMT, we start at the topmost
node and check the first four bits to find which top-level
bucket the value is stored in:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">get</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">type</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">must</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">support</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">method</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hash</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key-&gt;hash</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">0xf</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">this-&gt;data</span><span class="RktPn">[</span><span class="RktSym">hpiece</span><span class="RktPn">]</span><span class="RktSym">.k.bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">It</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">zero</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">null</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">failure</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">this-&gt;data</span><span class="RktPn">[</span><span class="RktSym">hpiece</span><span class="RktPn">]</span><span class="RktSym">.k.bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">It</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key/value</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pair</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">check</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">equality</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">*</span><span class="RktPn">(</span><span class="RktSym">this-&gt;data</span><span class="RktPn">[</span><span class="RktSym">hpiece</span><span class="RktPn">]</span><span class="RktSym">.k.key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">*key</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this-&gt;data</span><span class="RktPn">[</span><span class="RktSym">hpiece</span><span class="RktPn">]</span><span class="RktSym">.v.val</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">21</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">It</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">an</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">22</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtop::inner_find</span><span class="RktPn">(</span><span class="RktSym">this-&gt;data</span><span class="RktPn">[</span><span class="RktSym">hpiece</span><span class="RktPn">]</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">4</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">23</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>We use the first four bits of the hash to calculate which
index of <span class="stt">data</span> to look at next. The lowest bit of the
corresponding key for <span class="stt">data[hpiece]</span> is then used to
check if that bucket contains a key-value pair directly&ndash;in
which case the key is directly checked and the value
returned&ndash;or to see if <span class="stt">data[hpiece]</span> contains an inner
node, in which case we delegate to that node&rsquo;s <span class="stt">inner_find</span>. Note that <span class="stt">inner_find</span> is called with the
hash shifted by four.</p><h5>4.2.1<tt>&nbsp;</tt><a name="(part._.Lookup_from_an_inner_node)"></a>Lookup from an inner node</h5><p>Internal nodes look at six-bit pieces of the hash from
the 5th bit to the 64th bit in the hash. By convention, we
assume that <span class="stt">inner_find</span> will only look at the bottom six
bits of the hash, and that it will always be called in such
a way that the bits have been shifted appropriately:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">This</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">find</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">algorithm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">internal</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">nodes</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Given</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">row</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pointing</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">an</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">returns</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">given</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pair</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">or</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">none</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">exists</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">static</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner_find</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">0x3f</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">%</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">63</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bitmap</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">indicating</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">which</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">elements</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">are</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">actually</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stored</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">how</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">many</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">elements</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stores</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">popcount</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">index</span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">i.e.,</span><span class="hspace">&nbsp;</span><span class="RktCmt">how</span><span class="hspace">&nbsp;</span><span class="RktCmt">many</span><span class="hspace">&nbsp;</span><span class="RktCmt">KV</span><span class="hspace">&nbsp;</span><span class="RktCmt">elements</span><span class="hspace">&nbsp;</span><span class="RktCmt">*preceed*</span><span class="hspace">&nbsp;</span><span class="RktCmt">index</span><span class="hspace">&nbsp;</span><span class="RktCmt">hpiece</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv.v.node</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv.k.bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bool</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">exists</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">1UL</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">exists</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">__builtin_popcountll</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktVal">63</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><span class="nobreak">-</span></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.k.bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">*</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.k.key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">*key</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.v.val</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">21</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">22</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">23</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">24</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">25</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext::inner_find</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">6</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">26</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">27</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">28</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">29</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>Note that we right-shift the bitmap by one, because the
lowest bit will be set to 1 based on the tagging
scheme discussed above. We use the <span class="stt">__builtin_popcountll</span>
function to calculate <span class="stt">popcount</span> in an efficient way. The
compiler will then either generate architecture-specific
instructions, or (if compiling for an architecture where
<span class="stt">popcount</span> has not been implement) an
<a href="https://arxiv.org/pdf/1611.07612.pdf">optimized set of  assembly instructions</a>
to do so. We then use the result of
<span class="stt">popcount</span> to look up the corresponding index in <span class="stt">data</span>,
and perform the lookup for the key-value pair or
again delegate to <span class="stt">inner_find</span>.</p><h4>4.3<tt>&nbsp;</tt><a name="(part._.Inserting_.Into_.H.A.M.T)"></a>Inserting Into HAMT</h4><p>Inserting into a HAMT involves many of the same operations as
searching for a key-value pair. First, <span class="stt">popcount</span> is used to determine
the overall length of the compressed buffer <span class="stt">data</span>, and the index <span class="stt">i</span>
of the <span class="stt">KVnext</span> for the prefix that includes the next six-bit piece <span class="stt">hpiece</span>.
Note that because we need the lowest bit of <span class="stt">k</span> for tagging, we take each hash
piece modulo 63, conflating the numbers 0 and 64. Assuming our hash function is
decent, this shouldn&rsquo;t impact performance in practice.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Inserts</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">an</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">into</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">an</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">existing</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">and</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">returns</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">fresh</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">extended</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hash</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">static</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">insert_inner</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">cptr</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pointer</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">at</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv.v</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bitmap</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">indicating</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">which</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">elements</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">are</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">actually</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stored</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">how</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">many</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">elements</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">stores</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">popcount</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">index</span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">i.e.,</span><span class="hspace">&nbsp;</span><span class="RktCmt">how</span><span class="hspace">&nbsp;</span><span class="RktCmt">many</span><span class="hspace">&nbsp;</span><span class="RktCmt">KV</span><span class="hspace">&nbsp;</span><span class="RktCmt">elements</span><span class="hspace">&nbsp;</span><span class="RktCmt">*preceed*</span><span class="hspace">&nbsp;</span><span class="RktCmt">index</span><span class="hspace">&nbsp;</span><span class="RktCmt">hpiece</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv.v.node</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv.k.bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">0x3f</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">%</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">63</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">__builtin_popcountll</span><span class="RktPn">(</span><span class="RktSym">bm</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">__builtin_popcountll</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktVal">63</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><span class="nobreak">-</span></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bool</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">exists</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">1UL</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hpiece</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">exists</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Check</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">see</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">what</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kind</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KV</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pair</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">by</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">checking</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">lowest</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bit</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><span class="nobreak">-&gt;</span></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">an</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">actual</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktSym">,</span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pair</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><span class="nobreak">-&gt;</span></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">either</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">another</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">KV*</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">or</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">linked</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">list</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">LL&lt;K</span><span class="RktSym">,</span><span class="RktSym">V&gt;*</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">depending</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">on</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d+1</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.k.bm</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">21</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">22</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Does</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">match</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">exactly?</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">23</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">*</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.k.key</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">*key</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">24</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">25</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">already</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">exists</span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">replace</span><span class="hspace">&nbsp;</span><span class="RktCmt">the</span><span class="hspace">&nbsp;</span><span class="RktCmt">value</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">26</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext::update_node</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktPn">(</span><span class="RktSym">key</span><span class="RktSym">,</span><span class="RktSym">val</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">27</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktPn">(</span><span class="RktSym">kv.k.bm</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">28</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">29</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">30</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">31</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Merge</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">them</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">into</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">32</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">*cptr</span><span class="RktPn">)</span><span class="RktSym">++</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">33</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">childkv</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext::new_inner_node</span><span class="RktPn">(</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">34</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Passes</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">in</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">first</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">triple</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">of</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktSym">,</span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktSym">v</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">then</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">second</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">35</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">When</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">shifting</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">just-recomputed</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">hash</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">right</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">formula</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">computed</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">at</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">compile</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">time</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">36</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">This</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">also</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">means</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">warning</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">on</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d=9</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">template</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">instantiation</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">so</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">we</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">do</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">%64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">as</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d=10</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">37</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">does</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">not</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">care</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">in</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">any</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">case</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">as</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">it</span><span class="RktSym">'</span><span class="RktSym">s</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">definitely</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">LL*.</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">38</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.k.key-&gt;hash</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">6*</span><span class="RktPn">(</span><span class="RktSym">d+1</span><span class="RktPn">)</span><span class="RktVal">+4</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">%</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">64</span><span class="RktPn">)</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.k.key</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.v.val</span><span class="RktSym">,</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">39</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">6</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">40</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext::update_node</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">childkv</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">41</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktPn">(</span><span class="RktSym">kv.k.bm</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">42</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">43</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">44</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">.k</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">45</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">46</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">an</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">is</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">already</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">here</span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">recursively</span><span class="hspace">&nbsp;</span><span class="RktCmt">do</span><span class="hspace">&nbsp;</span><span class="RktCmt">an</span><span class="hspace">&nbsp;</span><span class="RktCmt">insert</span><span class="hspace">&nbsp;</span><span class="RktCmt">and</span><span class="hspace">&nbsp;</span><span class="RktCmt">replace</span><span class="hspace">&nbsp;</span><span class="RktCmt">it</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">47</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">childkv</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext::insert_inner</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktPn">[</span><span class="RktSym">i</span><span class="RktPn">]</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">6</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">val</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">cptr</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">48</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext::update_node</span><span class="RktPn">(</span><span class="RktSym">data</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">childkv</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">49</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktPn">(</span><span class="RktSym">kv.k.bm</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">50</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">51</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">52</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>If the <span class="stt">KVnext</span> for this <span class="stt">hpiece</span> exists in the compressed buffer <span class="stt">data</span>,
control takes the first branch of the conditional <span class="stt">if (exists)</span>, otherwise it takes
the second. When the the KV doesn&rsquo;t exist, a new inner node is allocated with one
additional index for the new key and value. A pointer to a counter value <span class="stt">cptr</span> is incremented
to track that the number of keys in the map has increased. A single KV of <span class="stt">KVtype</span>, as opposed
to <span class="stt">KVnext</span>, is returned that points to this larger internal node and has an updated bitmap.</p><p>In the case that the KV at hpiece exists, it is either a key and value, or another internal node.
If it is a key and value where the key matches exactly, the value can be updated in
a copy of the node that is returned. Functionally updating a single index of an internal node
is handled by a helper method <span class="stt">update_node</span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">static</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">update_node</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">old</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">i</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">copy</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">KVtype*</span><span class="RktPn">)</span><span class="RktSym">GC_MALLOC</span><span class="RktPn">(</span><span class="RktSym">count*sizeof</span><span class="RktPn">(</span><span class="RktSym">KVtype</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">std::memcpy</span><span class="RktPn">(</span><span class="RktSym">copy</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">old</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">count*sizeof</span><span class="RktPn">(</span><span class="RktSym">KV</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">copy+i</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktPn">(</span><span class="RktSym">kv</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">copy</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>If the key matches in its hash only, the two keys
are merged into a new internal node using a helper function <span class="stt">new_inner_node</span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">1</span><span class="hspace">&nbsp;</span></span></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Helper</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">returns</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">fresh</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">inner</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">for</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">two</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">merged</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">triples</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">2</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktSym">static</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new_inner_node</span><span class="RktPn">(</span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h0</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k0</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v0</span><span class="RktSym">,</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">3</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u64</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h1</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">K*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k1</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">V*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">4</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">5</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Take</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">the</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">lowest</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">6</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">bits</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">modulo</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">63</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">6</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h0piece</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">h0</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">0x3f</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">%</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">63</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">7</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">u32</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h1piece</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">h1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&amp;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">0x3f</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">%</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">63</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">8</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="hspace">&nbsp;</span><span class="stt">9</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">h0piece</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">==</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h1piece</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">10</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">11</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Create</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">to</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">merge</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">them</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">at</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d+1</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">12</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">childkv</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext::new_inner_node</span><span class="RktPn">(</span><span class="RktSym">h0</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">6</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k0</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v0</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&gt;&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">6</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">k1</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">v1</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">13</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">KVnext*</span><span class="RktPn">)</span><span class="RktSym">GC_MALLOC</span><span class="RktPn">(</span><span class="RktSym">sizeof</span><span class="RktPn">(</span><span class="RktSym">KVnext</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">14</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">node+0</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktPn">(</span><span class="RktSym">childkv</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">15</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">16</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv</span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">bitmap</span><span class="hspace">&nbsp;</span><span class="RktCmt">indicates</span><span class="hspace">&nbsp;</span><span class="RktCmt">h0piece,</span><span class="hspace">&nbsp;</span><span class="RktCmt">the</span><span class="hspace">&nbsp;</span><span class="RktCmt">shared</span><span class="hspace">&nbsp;</span><span class="RktCmt">child</span><span class="hspace">&nbsp;</span><span class="RktCmt">inner</span><span class="hspace">&nbsp;</span><span class="RktCmt">node</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">17</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">1UL</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h0piece</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">\|</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">18</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">19</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">20</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">21</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">The</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">two</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">key/value</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">pairs</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">exist</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">at</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">different</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">buckets</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">at</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">this</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">d</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">22</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">allocate</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">them</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">in</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">proper</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">order</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">23</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext*</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">const</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">=</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">KVnext*</span><span class="RktPn">)</span><span class="RktSym">GC_MALLOC</span><span class="RktPn">(</span><span class="RktSym">2*sizeof</span><span class="RktPn">(</span><span class="RktSym">KVnext</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">24</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">if</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">h1piece</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h0piece</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">25</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">26</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">node+0</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktPn">(</span><span class="RktSym">k1</span><span class="RktSym">,</span><span class="RktSym">v1</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">27</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">node+1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktPn">(</span><span class="RktSym">k0</span><span class="RktSym">,</span><span class="RktSym">v0</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">28</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">29</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">else</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">30</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">{</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">31</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">node+0</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktPn">(</span><span class="RktSym">k0</span><span class="RktSym">,</span><span class="RktSym">v0</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">32</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">node+1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVnext</span><span class="RktPn">(</span><span class="RktSym">k1</span><span class="RktSym">,</span><span class="RktSym">v1</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">33</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">34</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">35</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">36</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">//</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">Return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">a</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">new</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">kv</span><span class="RktCmt">;</span><span class="hspace">&nbsp;</span><span class="RktCmt">bitmap</span><span class="hspace">&nbsp;</span><span class="RktCmt">indicates</span><span class="hspace">&nbsp;</span><span class="RktCmt">both</span><span class="hspace">&nbsp;</span><span class="RktCmt">h0piece</span><span class="hspace">&nbsp;</span><span class="RktCmt">and</span><span class="hspace">&nbsp;</span><span class="RktCmt">h1piece</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">37</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktSym">return</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">KVtype</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">1UL</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h0piece</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">\|</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">1UL</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">h1piece</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;&lt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">\|</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktSym">,</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">node</span><span class="RktPn">)</span><span class="RktCmt">;</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">38</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr><tr><td><span class="Smaller"><span class="Smaller"><span class="stt">39</span><span class="hspace">&nbsp;</span></span></span><span class="RktMeta"></span><span class="RktPn">}</span><span class="RktMeta"></span></td></tr></table></blockquote><p>Note that in the case where the two keys continue to match in the next chunk of their hash,
the helper <span class="stt">new_inner_node</span> makes a recusive call to itself.</p></div></div><div id="contextindicator">&nbsp;</div></body></html>